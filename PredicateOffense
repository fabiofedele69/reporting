WITH PredicateOffences AS (
    SELECT
        LISTAGG(ATTRIB.ATTRIBUTE_VALUE, ',')
            WITHIN GROUP (ORDER BY ATTRIB.ATTRIBUTE_TYPE) AS PredicateOffence
    FROM LC_SCMT.WORK_ITEM_MULTI_VAL_ATTRIBUTES ATTRIB
    WHERE ATTRIB.ATTRIBUTE_TYPE = 5119
      AND ATTRIB.WORK_ITEM_ID = '@case_id@'
),

Passports AS (
    SELECT
        LISTAGG(ATTRIB.ATTRIBUTE_VALUE, ',')
            WITHIN GROUP (ORDER BY ATTRIB.ATTRIBUTE_TYPE) AS Passport
    FROM LC_SCMT.WORK_ITEM_MULTI_VAL_ATTRIBUTES ATTRIB
    WHERE ATTRIB.ATTRIBUTE_TYPE = 5998
      AND ATTRIB.WORK_ITEM_ID = '@case_id@'
),

LREGION AS (
    SELECT DISTINCT
        NVL(LR.MD_REL_LIST_ITEM_VALUE, '') AS Region
    FROM LC_RCM_INC.ALERTS A
    INNER JOIN LC_SCMT.MD_REL_LIST_ITEMS LI
        ON LI.MD_REL_LIST_ITEM_VALUE = A.BUNIT_IDENTIFIER
    INNER JOIN LC_SCMT.BUSINESS_UNIT_DEPENDENCIES BU
        ON LI.MD_REL_LIST_ITEM_ID = BU.BU_ID
    INNER JOIN LC_SCMT.MD_REL_LIST_ITEMS LR
        ON LR.MD_REL_LIST_ITEM_ID = BU.INVEST_REGION_ID
    WHERE A.ALERT_ID = '@case_id@'
),

OWN_ENT AS (
    SELECT
        OE.ALERT_ID,
        '[' ||
        LISTAGG(
            NVL(OE.BUSINESS_DIV_CODE, '') || ',' ||
            NVL(BD.BUSINESS_DIVISION, '') || ',' ||
            NVL(OE.REGION_CODE, '') || ',' ||
            NVL(OE.COUNTRY_CODE, '') || ',' ||
            NVL(OE.UDS_ENTITY_CODE, '') || ',' ||
            NVL(SE.SHORT_ENTITY_NAME, OE.UDS_ENTITY_VAL) || ',' ||
            NVL(OE.LINE_OF_BUSINESS_CODE, '') || ',' ||
            NVL(OE.LINE_OF_BUSINESS_VAL, '') || ',' ||
            NVL(OE.IS_PRIMARY, '') || ',' ||
            NVL(OE.BUSINESS_AREA_CODE, '') || ',' ||
            NVL(OE.BUSINESS_AREA_VAL, '')
            , '|'
        ) WITHIN GROUP (ORDER BY OE.ALERT_ID)
        || ']' AS OWN_ENT
    FROM LC_SCMT.SCMT_OWNING_UDS_ENTITIES OE
    INNER JOIN (
        SELECT 'Investment Bank' AS BUSINESS_DIVISION, 'IB' AS BUSINESS_DIV_CODE FROM DUAL
        UNION ALL
        SELECT 'Wealth Management', 'WM' FROM DUAL
        UNION ALL
        SELECT 'Wealth Management Americas', 'WMA' FROM DUAL
        UNION ALL
        SELECT 'Asset Management', 'AM' FROM DUAL
        UNION ALL
        SELECT 'Personal and Corporate', 'P&C' FROM DUAL
        UNION ALL
        SELECT 'Asset Management Joint Venture', 'WJV' FROM DUAL
        UNION ALL
        SELECT 'Corporate Branch', 'CB' FROM DUAL
    ) BD
        ON OE.BUSINESS_DIV_CODE = BD.BUSINESS_DIV_CODE
    LEFT JOIN LC_SCMT.SCMT_SORT_ENTITIES SE
        ON OE.UDS_ENTITY_CODE = SE.UDS_ENTITY_CODE
    WHERE OE.ALERT_ID = '@case_id@'
    GROUP BY OE.ALERT_ID
)

SELECT
    WIT.CASE_DESCRIPTION AS "Case Description",

    CASE
        WHEN PR.PredicateOffence IS NULL THEN ''
        ELSE '[' || PR.PredicateOffence || ']'
    END AS "PredicateOffences",

    CASE
        WHEN P.Passport IS NULL THEN ''
        ELSE '[' || P.Passport || ']'
    END AS "Passport",

    NVL(OE.OWN_ENT, '') AS OWN_ENT,
    NVL(LR.Region, '') AS "Logical Region",

    NVL(S.STATUS_NAME, '') AS "Case Step",
    NVL(USR.FULL_NAME, '') AS "Current Owner",
    TO_CHAR(A.CREATE_DATE, 'yyyy/mm/dd') AS "Case Opened Date",

    NVL(WIT.CASE_ANALYSIS, '') AS "CASE_ANALYSIS",
    NVL(WIT.CASE_CONCLUSION, '') AS "CASE_CONCLUSION"

FROM LC_RCM_INC.ALERTS A
LEFT JOIN LC_RCM_INC.ACM_ALERT_CUSTOM_ATTRIBUTES AC
    ON A.ALERT_CUSTOM_ATTRIBUTES_ID = AC.ALERT_CUSTOM_ATTRIBUTES_ID
INNER JOIN LC_RCM_INC.ACM_MD_ALERT_STATUSES S
    ON A.STATUS_INTERNAL_ID = S.STATUS_INTERNAL_ID
INNER JOIN LC_RCM_INC.ACM_MD_ALERT_TYPES TC
    ON A.ALERT_TYPE_INTERNAL_ID = TC.ALERT_TYPE_INTERNAL_ID
INNER JOIN LC_SCMT.WORK_ITEM_TYPES_CLASSES WTC
    ON TC.WORK_ITEM_TYPE_ID = WTC.WORK_ITEM_TYPE_ID
LEFT JOIN LC_RCM_INC.ACM_USERS USR
    ON A.OWNER_INTERNAL_ID = USR.USER_INTERNAL_ID
LEFT JOIN LC_SCMT.WORK_ITEM_ATTRIBUTES WIT
    ON WIT.WORK_ITEM_ID = A.ALERT_ID

LEFT JOIN LREGION LR
    ON 1 = 1
LEFT JOIN PredicateOffences PR
    ON 1 = 1
LEFT JOIN Passports P
    ON 1 = 1
LEFT JOIN OWN_ENT OE
    ON 1 = 1

WHERE A.ALERT_ID = '@case_id@';
