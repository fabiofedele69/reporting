CREATE OR REPLACE VIEW vw_case_latest_four_eye AS
SELECT
    a.caseid,
    a.alert_type_id,
    f.trans_date,
    f.action_performer,
    f.action_desc
FROM lc_rcm_inc.alerts a
CROSS APPLY (
    SELECT
        t.trans_date,
        t.action_performer,
        t.action_desc
    FROM (
        SELECT
            t.*,
            ROW_NUMBER() OVER (
                ORDER BY t.trans_date DESC
            ) AS rn
        FROM TABLE (
            lc_scmt.fn_fcscmt_invest_prog_raw(a.caseid)
        ) t
        WHERE t.action_desc IN (
            'Case Four Eye Check Performed'
        )
    )
    WHERE rn = 1
) f
WHERE a.alert_type_id = 3;


CREATE OR REPLACE VIEW vw_case_latest_four_eye AS
SELECT
    a.caseid,
    a.alert_type_id,
    f.trans_date,
    f.action_performer,
    f.action_desc
FROM lc_rcm_inc.alerts a
CROSS APPLY (
    SELECT
        trans_date,
        action_performer,
        action_desc
    FROM (
        SELECT
            t.trans_date,
            t.action_performer,
            t.action_desc,
            ROW_NUMBER() OVER (
                ORDER BY t.trans_date DESC
            ) rn
        FROM TABLE(
            lc_scmt.fn_fcscmt_invest_prog_raw(a.caseid)
        ) t
        WHERE t.action_desc = 'Case Four Eye Check Performed'
    )
    WHERE rn = 1
) f
WHERE a.alert_type_id = 3;


CREATE OR REPLACE VIEW vw_alert_latest_four_six_eye AS
SELECT
    alert_id,
    eye_check_type,
    trans_date,
    comments
FROM (
    SELECT
        a.alert_id,
        CASE
            WHEN aud.note LIKE '%Four Eye%' THEN 'FOUR_EYE'
            WHEN aud.note LIKE '%Six Eye%'  THEN 'SIX_EYE'
        END AS eye_check_type,
        aud.create_date AS trans_date,
        aud.comments,
        ROW_NUMBER() OVER (
            PARTITION BY
                a.alert_id,
                CASE
                    WHEN aud.note LIKE '%Four Eye%' THEN 'FOUR_EYE'
                    WHEN aud.note LIKE '%Six Eye%'  THEN 'SIX_EYE'
                END
            ORDER BY aud.create_date DESC
        ) rn
    FROM lc_rcm_inc.alerts a
    JOIN lc_rcm_inc.acm_audits aud
        ON aud.alert_internal_id = a.alert_internal_id
    WHERE aud.comments IS NOT NULL
      AND (
            aud.note LIKE '%Four Eye%'
         OR aud.note LIKE '%Six Eye%'
      )
)
WHERE rn = 1;
