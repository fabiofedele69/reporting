CREATE OR REPLACE VIEW vw_case_latest_four_eye AS
SELECT
    a.caseid,
    a.alert_type_id,
    f.trans_date,
    f.action_performer,
    f.action_desc
FROM lc_rcm_inc.alerts a
CROSS APPLY (
    SELECT
        t.trans_date,
        t.action_performer,
        t.action_desc
    FROM (
        SELECT
            t.*,
            ROW_NUMBER() OVER (
                ORDER BY t.trans_date DESC
            ) AS rn
        FROM TABLE (
            lc_scmt.fn_fcscmt_invest_prog_raw(a.caseid)
        ) t
        WHERE t.action_desc IN (
            'Case Four Eye Check Performed'
        )
    )
    WHERE rn = 1
) f
WHERE a.alert_type_id = 3;
